<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AdSense parser</title>
    <link href="/main.css" media="screen" rel="stylesheet" type="text/css" />

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-19737348-5']);
        _gaq.push(['_setDomainName', 'esemi.ru']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>
<body>
    <div id="main">
        <div>
            <h3>Итоговые показатели</h3>
            <p>В базе 1000 доменов, 606 рекламных блоков, <strong>40`201</strong> уникальных объявлений</p>
            <p>Всего обработано <strong>39`168`500</strong> рекламных блоков за 23ч. 00м. 52с.. </p>
            <p>Средняя скорость обработки <strong>472.75</strong> блоков в секунду.</p>
        </div>

        <div>
            <h3>Поиск объявлений</h3>
            <form method="POST" name="search" action="">
                <input type="text" value="" name="term" placeholder="введите искомую фразу"/>
                <input type="submit" value="найти" name="найти" disabled="disabled"/>
            </form>
            <p>А поиск отключен за давностью лет, но можно скачать <a href="/semrush_db_dump.gz" target="_blank">дамп БД</a> =)</p>
        </div>

        <div class="semrush">
            <h3>Исходная задача</h3>
            <p>Имеется 1000 доменов, нужно с каждого собрать текстовые Google Adsense объявления (к&nbsp;ним относятся заголовок, текст, адрес сайта, на который ссылается реклама).</p>
            <p>Реализовать полнотекстовый поиск по объявлениям и веб-интерфейс к нему. </p>
            <p>Объявлений нужно собрать как можно больше за время не более одних полных суток.</p>
            <h3>Решение</h3>
            <p>В качестве хранилища была взята mysql (innoDB), поскольку оказалась под рукой. По хорошему надо заменить её на что-либо с быстрой и асинхронной записью (тот же mongoDB) и поставить для полнотекстового поиска Sphinx (сейчас используется зеркало в MyISAM).</p>
            <p>За сбор данных отвечают два фоновых скрипта - <em>checker</em> и <em>loader</em>. Написаны на python с использованием curl (реализация на php полностью аналогична, просто curl multi там бывает зависает без видимых причин).</p>
            <strong><em>checker</em></strong><br/>
            <p>Раз в несколько часов скрипт выкачивает главные страницы всех доменов и парсит оные на предмет кода гуглрекламы. Из всех найденных кодов формируются ссылки на гугловский сервис раздачи рекламы и сохраняются в БД.</p>
            <p>Следующим шагом все найденные ссылки выкачиваются и проверяются на валидность (бывает код рекламы на сайте есть, но просрочен или не верен). Все невалидные ссылки из БД удаляются. Также с валидных ссылок собирается уникальный id, одаваемый гуглом в куках (если его не возвращать всё время отображаются одни и те же объявления).</p>
            <p>На все действия уходит около полутора минут. За это время с 1000 доменов собирается около 600 рабочих рекламных блоков.</p>
            <strong><em>loader</em></strong><br/>
            <p>Выбираются несколько ссылок на рекламные блоки и каждая из них загружается некоторое количество раз. Ответы парсятся на текстовые объявления и уникальные пары оных (ссылка+заголовок) сохраняются в БД.</p>
            <p>Периодичность запуска скрипта зависит от количества ссылок и повторов каждой из них.</p>
            <p>В моём случае за раз обрабатывались все 620 ссылок по 100 загрузок каждой (около двух минут по времени).</p>
            <p>Один работающий скрипт забил канал на 40 мбит и одно полное ядро ЦП, поэтому при желании можно запустить его в двух экземплярах на много ядерной машине.</p>
            <p><a href="https://github.com/esemi/semrush-test-2012" target="_blank">сорцы</a></p>
        </div>
    </div>
</body>
</html>